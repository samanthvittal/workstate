{% comment %}
Pomodoro completion notification modal.

Shows when a 25-minute work interval completes, prompting user to take a break.
{% endcomment %}

<div x-data="pomodoroNotification"
     x-show="show"
     x-cloak
     class="fixed inset-0 z-50 overflow-y-auto"
     aria-labelledby="pomodoro-modal-title"
     role="dialog"
     aria-modal="true">

    <!-- Background overlay -->
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
         x-show="show"
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click="close()"></div>

    <!-- Modal panel -->
    <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6"
             x-show="show"
             x-transition:enter="ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave="ease-in duration-200"
             x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">

            <!-- Success icon -->
            <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100">
                <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                </svg>
            </div>

            <!-- Modal content -->
            <div class="mt-3 text-center sm:mt-5">
                <h3 class="text-lg font-semibold leading-6 text-gray-900" id="pomodoro-modal-title">
                    Pomodoro Complete!
                </h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-500">
                        Great work! You've completed <span x-text="sessionNumber"></span> Pomodoro session<span x-show="sessionNumber > 1">s</span>.
                    </p>
                    <p class="mt-2 text-sm text-gray-700 font-medium">
                        Take a <span x-text="breakMinutes"></span>-minute break?
                    </p>
                </div>
            </div>

            <!-- Action buttons -->
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                <button type="button"
                        @click="startBreak()"
                        class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 sm:col-start-2">
                    Start Break
                </button>
                <button type="button"
                        @click="skipBreak()"
                        class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:col-start-1 sm:mt-0">
                    Skip Break
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('pomodoroNotification', () => ({
        show: false,
        sessionId: null,
        sessionNumber: 1,
        breakMinutes: 5,

        init() {
            // Listen for Pomodoro completion events
            window.addEventListener('pomodoro-complete', (event) => {
                this.showNotification(event.detail);
            });
        },

        showNotification(data) {
            this.sessionId = data.session_id;
            this.sessionNumber = data.session_number;
            this.breakMinutes = data.break_minutes || 5;
            this.show = true;

            // Play audio notification if available
            this.playNotificationSound();
        },

        playNotificationSound() {
            // Simple beep using AudioContext
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Audio notification not supported:', e);
            }
        },

        startBreak() {
            // Mark break as taken
            fetch(`/time_tracking/api/pomodoro/${this.sessionId}/break/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': this.getCsrfToken(),
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Trigger break timer in main timer widget
                    window.dispatchEvent(new CustomEvent('pomodoro-break-start', {
                        detail: {
                            duration_minutes: this.breakMinutes,
                            session_id: this.sessionId,
                        }
                    }));
                }
            })
            .catch(error => {
                console.error('Error starting break:', error);
            });

            this.close();
        },

        skipBreak() {
            // Just close the modal, continue working
            this.close();
        },

        close() {
            this.show = false;
        },

        getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        },
    }));
});
</script>
