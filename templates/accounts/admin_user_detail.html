{% extends "base.html" %}

{% block title %}User Details: {{ user.email }} - Admin Dashboard - Workstate{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Mobile menu button -->
    <div class="lg:hidden" x-data="{ mobileMenuOpen: false }">
        <button @click="mobileMenuOpen = !mobileMenuOpen" class="fixed top-4 left-4 z-50 bg-white p-2 rounded-md shadow-lg lg:hidden">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>

        <!-- Mobile sidebar -->
        <div x-show="mobileMenuOpen" @click.away="mobileMenuOpen = false" class="fixed inset-0 z-40 lg:hidden" x-cloak>
            <div class="fixed inset-0 bg-gray-600 bg-opacity-75"></div>
            <nav class="fixed top-0 left-0 bottom-0 flex flex-col w-64 bg-white shadow-xl">
                <div class="flex items-center justify-between p-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Admin Menu</h2>
                    <button @click="mobileMenuOpen = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    <a href="{% url 'accounts:admin_user_list' %}" class="block px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-lg mb-2">
                        User Management
                    </a>
                    <a href="/" class="block px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-lg">
                        Back to Dashboard
                    </a>
                </div>
            </nav>
        </div>
    </div>

    <!-- Desktop layout -->
    <div class="flex">
        <!-- Sidebar - Desktop -->
        <aside class="hidden lg:flex lg:flex-col w-64 bg-white border-r border-gray-200 fixed h-screen">
            <div class="flex items-center justify-center h-16 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900">Admin Panel</h2>
            </div>
            <nav class="flex-1 overflow-y-auto p-4">
                <a href="{% url 'accounts:admin_user_list' %}" class="block px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-lg mb-2">
                    User Management
                </a>
                <a href="/" class="block px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-lg">
                    Back to Dashboard
                </a>
            </nav>
        </aside>

        <!-- Main content area -->
        <main class="flex-1 lg:ml-64">
            <!-- Header -->
            <header class="bg-white border-b border-gray-200">
                <div class="px-4 sm:px-6 lg:px-8 py-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="flex items-center">
                                <a href="{% url 'accounts:admin_user_list' %}" class="text-gray-400 hover:text-gray-600 mr-4">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                    </svg>
                                </a>
                                <div>
                                    <h1 class="text-2xl font-bold text-gray-900">User Details</h1>
                                    <p class="mt-1 text-sm text-gray-600">{{ user.email }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content -->
            <div class="px-4 sm:px-6 lg:px-8 py-8">
                <div id="admin-action-result" class="mb-4"></div>

                <!-- User Information Card -->
                <div class="bg-white shadow-sm rounded-lg overflow-hidden mb-6">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">User Information</h2>
                    </div>
                    <div class="px-6 py-4">
                        <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Full Name</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ profile.full_name|default:"Not set" }}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Email</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ user.email }}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Job Title</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ profile.job_title|default:"Not set" }}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Company</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ profile.company|default:"Not set" }}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Phone Number</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ profile.phone_number|default:"Not set" }}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Registration Date</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ user.date_joined|date:"F d, Y H:i" }}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Account Status</dt>
                                <dd class="mt-1">
                                    {% if is_locked %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                            Locked
                                        </span>
                                        {% if lockout_end_time %}
                                            <span class="ml-2 text-xs text-gray-500">Until {{ lockout_end_time|date:"H:i" }}</span>
                                        {% endif %}
                                    {% elif user.is_active %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            Active
                                        </span>
                                    {% else %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                            Unverified
                                        </span>
                                    {% endif %}
                                </dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Admin Status</dt>
                                <dd class="mt-1">
                                    {% if user.is_staff %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                            Admin
                                        </span>
                                    {% else %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                            Regular User
                                        </span>
                                    {% endif %}
                                </dd>
                            </div>
                        </dl>
                    </div>
                </div>

                <!-- Preferences Card -->
                <div class="bg-white shadow-sm rounded-lg overflow-hidden mb-6">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Preferences</h2>
                    </div>
                    <div class="px-6 py-4">
                        <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Timezone</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ preferences.timezone|default:"Not set" }}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Date Format</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ preferences.date_format|default:"Not set" }}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Time Format</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ preferences.get_time_format_display|default:"Not set" }}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Week Start Day</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ preferences.week_start_day|default:"Not set" }}</dd>
                            </div>
                        </dl>
                    </div>
                </div>

                <!-- Workspace Information Card -->
                <div class="bg-white shadow-sm rounded-lg overflow-hidden mb-6">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Workspaces</h2>
                    </div>
                    <div class="px-6 py-4">
                        {% if workspaces %}
                            <ul class="divide-y divide-gray-200">
                                {% for workspace in workspaces %}
                                <li class="py-3">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-gray-900">{{ workspace.name }}</p>
                                            <p class="text-xs text-gray-500">Created {{ workspace.created_at|date:"M d, Y" }}</p>
                                        </div>
                                        {% if workspace.is_personal %}
                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                                Personal
                                            </span>
                                        {% endif %}
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-sm text-gray-500">No workspaces found.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Login History Table -->
                <div class="bg-white shadow-sm rounded-lg overflow-hidden mb-6">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Login History</h2>
                        <p class="mt-1 text-sm text-gray-600">Last 10 login attempts</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Timestamp
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Status
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        IP Address
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for attempt in login_attempts %}
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        {{ attempt.timestamp|date:"M d, Y H:i:s" }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        {% if attempt.is_successful %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                Successful
                                            </span>
                                        {% else %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                Failed
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {{ attempt.ip_address|default:"Unknown" }}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500">
                                        No login attempts recorded.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="bg-white shadow-sm rounded-lg overflow-hidden" x-data="{ showDeleteConfirm: false }">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Actions</h2>
                    </div>
                    <div class="px-6 py-4">
                        <div class="flex flex-wrap gap-3">
                            {% if is_locked %}
                                <button
                                    hx-post="{% url 'accounts:admin_unlock_account' user_id=user.id %}"
                                    hx-target="#admin-action-result"
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    Unlock Account
                                </button>
                            {% endif %}

                            <button
                                hx-post="{% url 'accounts:admin_trigger_password_reset' user_id=user.id %}"
                                hx-target="#admin-action-result"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                Send Password Reset
                            </button>

                            <div id="admin-toggle-btn">
                                <button
                                    hx-post="{% url 'accounts:admin_toggle_admin' user_id=user.id %}"
                                    hx-target="#admin-action-result"
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white {% if user.is_staff %}bg-yellow-600 hover:bg-yellow-700 focus:ring-yellow-500{% else %}bg-blue-600 hover:bg-blue-700 focus:ring-blue-500{% endif %} focus:outline-none focus:ring-2 focus:ring-offset-2">
                                    {% if user.is_staff %}Revoke Admin{% else %}Grant Admin{% endif %}
                                </button>
                            </div>

                            <!-- Delete button with Alpine.js confirmation -->
                            <button
                                @click="showDeleteConfirm = true"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                Delete User
                            </button>

                            <!-- Delete confirmation modal -->
                            <div x-show="showDeleteConfirm" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
                                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                                    <div x-show="showDeleteConfirm" @click="showDeleteConfirm = false" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>

                                    <div x-show="showDeleteConfirm" class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                            <div class="sm:flex sm:items-start">
                                                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                                                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                                    </svg>
                                                </div>
                                                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                                    <h3 class="text-lg leading-6 font-medium text-gray-900">Delete User</h3>
                                                    <div class="mt-2">
                                                        <p class="text-sm text-gray-500">
                                                            Are you sure you want to delete this user? This will permanently delete the user and all associated data including profile, preferences, workspaces, and login history. This action cannot be undone.
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                            <button
                                                hx-post="{% url 'accounts:admin_delete_user' user_id=user.id %}"
                                                type="button"
                                                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm"
                                                @click="showDeleteConfirm = false">
                                                Delete
                                            </button>
                                            <button
                                                @click="showDeleteConfirm = false"
                                                type="button"
                                                class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}
